# Judge0 Docker Compose for CodeArena
# Run with: docker-compose -f judge0.docker-compose.yml up -d

version: "3.8"

x-logging: &default-logging
  logging:
    driver: json-file
    options:
      max-size: "100m"
      max-file: "5"

services:
  judge0:
    image: judge0/judge0:1.13.0
    <<: *default-logging
    ports:
      - "2358:2358"
    privileged: true
    environment:
      - REDIS_HOST=redis
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=judge0
      - POSTGRES_USER=judge0
      - POSTGRES_PASSWORD=judge0password
      - ENABLE_WAIT_RESULT=true
      - ENABLE_BATCHED_SUBMISSIONS=true
      - MAX_QUEUE_SIZE=100
      - CPU_TIME_LIMIT=5
      - MAX_CPU_TIME_LIMIT=15
      - WALL_TIME_LIMIT=10
      - MAX_WALL_TIME_LIMIT=20
      - MEMORY_LIMIT=256000
      - MAX_MEMORY_LIMIT=512000
      - STACK_LIMIT=64000
      - MAX_STACK_LIMIT=128000
      - MAX_PROCESSES_AND_OR_THREADS=60
      - ENABLE_PER_PROCESS_AND_THREAD_TIME_LIMIT=false
      - ENABLE_PER_PROCESS_AND_THREAD_MEMORY_LIMIT=false
      - ENABLE_NETWORK=false
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    <<: *default-logging
    environment:
      - POSTGRES_DB=judge0
      - POSTGRES_USER=judge0
      - POSTGRES_PASSWORD=judge0password
    volumes:
      - judge0-postgres-data:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    <<: *default-logging
    command: redis-server --appendonly yes
    volumes:
      - judge0-redis-data:/data
    restart: unless-stopped

  # Workers to process submissions
  workers:
    image: judge0/judge0:1.13.0
    <<: *default-logging
    command: ./scripts/workers
    environment:
      - REDIS_HOST=redis
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=judge0
      - POSTGRES_USER=judge0
      - POSTGRES_PASSWORD=judge0password
      - INTERVAL=0.1
      - COUNT=4
    privileged: true
    depends_on:
      - judge0
      - postgres
      - redis
    restart: unless-stopped

volumes:
  judge0-postgres-data:
  judge0-redis-data:
